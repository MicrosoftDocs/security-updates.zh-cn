---
TOCTitle: RMS 管理问题
Title: RMS 管理问题
ms:assetid: '97013c08-d3fa-4ea0-8914-995b6c97f900'
ms:contentKeyID: 18112661
ms:mtpsurl: 'https://technet.microsoft.com/zh-cn/library/Cc747605(v=WS.10)'
---

RMS 管理问题
============

在服务器上成功地设置 RMS 之后，在 RMS 的日常管理工作中您可能会遇到一些问题。可以使用以下各部分中的信息来帮助您解决其中一些问题。

尝试打开 RMS 管理网站时，接收到“SQL Server 不存在或拒绝访问”消息
----------------------------------------------------------------

如果安装 RMS 时使用新安装的 SQL Server 2005 作为数据库服务器，则可能是未启动 SQL Server 服务。在 SQL Server 2005 中，MSSQLSERVER 服务未配置为在启动服务器时自动启动。如果自从安装 RMS 之后已经重新启动了 SQL Server 且未将此服务配置为自动重新启动，则 RMS 将不能运行且只有 RMS 全局管理页是可以访问的。

启动 MSSQLSERVER 服务之后，必须重新启动 RMS 服务器上的 IIS 以恢复 RMS 功能。

无法完成脱机注册过程
--------------------

如果注册请求文件在被提交给注册服务网站之前不完整或已修改，则无法完成脱机注册。注册请求文件可能被恶意程序、用户错误或系统错误损坏。

根据丢失的信息的不同，注册服务网站仍可能接受该文件并返回服务器许可方证书，也可能拒绝接受该请求文件并报告出错。

如果返回了服务器许可方证书，则它将反映注册请求文件中存在的遗漏或损坏，当您尝试导入该证书时，RMS 将报告出错。

如果无法完成注册过程，请检查连接 Internet 的计算机没有病毒，从您的 RMS 服务器再次导出该注册请求文件，然后使用不同的媒体将它传输到连接 Internet 的计算机。如果再次遇到该错误，请与 Microsoft 产品支持服务联系。

未创建日志文件
--------------

RMS 日志服务需要 Message Queuing（也称作 MSMQ）服务以及对日志数据库的访问。如果未创建日志文件，则可能意味着未正确配置组件或组件之间的通信被中断。

请测试以确保 RMS 服务器和数据库服务器之间的网络连接正常。如果网络连接正常，请按照以下过程审核 RMS 日志服务的先决条件并确保正确配置了所有软件依赖项。

首先，请验证 Message Queuing 配置是否正确。必须在启用了“Active Directory 集成”的情况下安装 Message Queuing。

**验证是否已正确安装和配置 Message Queuing**
1.  在“**控制面板**”中，单击“**添加/删除程序**”，然后单击“**添加/删除 Windows 组件**”以打开“**Windows 组件向导**”。

2.  在“**Windows 组件向导**”中，选中“**应用程序服务器**”复选框，然后单击“**详细信息**”。

3.  选择“**Message Queuing**”复选框，然后单击“**详细信息**”。

4.  如果“**Active Directory 集成**”复选框已选中，请继续下一项测试并验证 Message Queuing 是否正在运行。如果该复选框未被选中，请继续执行步骤 5 到 9。

5.  单击“**开始**”，依次指向“**所有程序**”和“**Windows RMS**”，然后单击“**Windows RMS 管理**”以打开“全局管理”页。

6.  在设置了 RMS 的网站旁边，单击“**从此网站删除 RMS**”，然后单击“**确定**”。

7.  在“**控制面板**”上的“**添加/删除程序**”中，依次单击“**添加/删除 Windows 组件**”和“**应用程序服务器**”，然后单击“**Message Queuing**”。

8.  要启用“**Active Directory 集成**”功能，请单击“**详细信息**”，并选中“**Active Directory 集成**”复选框，然后单击“**确定**”。

9.  打开“**全局管理**”页。在要设置 RMS 的网站名称旁边，单击“**在此网站上设置 RMS**”。

其次，验证 Message Queuing 是否正在服务器上运行。

**验证 Message Queuing 是否正在服务器上运行**
1.  在“**控制面板**”中，单击“**管理工具**”，然后单击“**服务**”。

2.  向下滚动服务列表，直到找到“**Message Queuing**”服务。

3.  在“**状态**”栏中，该服务应报告为“**已启动**”；如果不是这样，请右键单击该服务，然后单击“**启动**”。

第三步，请验证日志服务是否具有将事件写入日志数据库的权限。通过使用 RMS 服务帐户运行 RMS 日志服务。请验证该 RMS 服务帐户是否成功登录到数据库服务器，且它是否被授予了创建数据库和将信息写入文件所需的权限。

一旦已满足上述所有先决条件，请通过使用服务管理单元停止并重新启动 RMS 日志服务。RMS 日志服务重新启动之后，应在数据库服务器上创建了日志文件。如果使用了 SQL Server 作为您的数据库服务器，则以下过程显示如何验证是否正在创建日志文件。

**验证是否正在 SQL Server 上创建日志文件**
1.  在 SQL Server Enterprise Manager 中，访问日志数据库，并展开“**数据库**”，然后展开 RMS 日志数据库。

2.  依次单击日志数据库和“**表**”，并用右键单击“**DRMS\_log\_master**”，然后单击“**打开表 – 返回所有行**”。如果正在创建日志文件，您将会看到一个或多个日志文件。

恢复配置数据库
--------------

如果配置数据库工作不正常，则 RMS 无法运行。如果配置数据库有问题，如数据库服务器上的数据库损坏或硬盘出现故障，可以通过恢复配置数据库的备份来恢复 RMS 的运行。要使用备份恢复 RMS 配置数据库，需要知道以下信息：

-   数据库的最新备份的名称。
-   将恢复备份数据库的计算机的名称。
-   最初用来设置 RMS 的帐户名和密码。
-   最初为软件私钥保护（如果已使用）指定的密码。

从备份数据库执行恢复操作时，既不需要新的服务器许可方证书，也不需要新的私钥，因为 RMS 保留了所有的设置（可以从备份配置数据库获得）。

您可以按照以下过程恢复备份数据库：

**恢复备份数据库**
1.  单击“**开始**”，依次指向“**所有程序**”和“**Windows RMS**”，然后单击“**Windows RMS 管理**”以打开“**全局管理**”页。

2.  在设置了 RMS 的网站旁边，单击“**从此网站删除 RMS**”，然后单击“**确定**”。

3.  恢复配置数据库的备份数据库文件。如果在备份过程中备份了日志数据库，且需要维护数据的连续性，则还要恢复日志数据库。

    -   如果在整个系统出现故障后恢复该系统，则在恢复备份数据库文件之前请使用系统状态备份恢复注册表。

4.  如果正在恢复的数据库用于单个根认证服务器，则需修改以下注册表项，然后再尝试重新设置服务：

    -   在运行 Windows Server 2003 32 位版本的计算机上
        `HKEY_LOCAL_MACHINE\Software\Microsoft\DRMS\1.0\`
    -   在运行 Windows Server 2003 64 位版本的计算机上
        `HKEY_LOCAL_MACHINE\Software\WOW6432Node\Microsoft\DRMS\1.0\`

    添加以下的注册表项作为字符串值并保留该值为空：

    `GicURL`

    这样做将覆盖根认证服务器的 Active Directory 发现功能，并允许您访问根认证服务器的设置页。

5.  如果使用了硬件安全模块来保证 RMS 私钥的安全，请恢复备份安全设置，以便能检索到这些密钥。

6.  请按下列步骤之一操作：

    -   要恢复单个服务器而非群集的数据库，请单击要设置 RMS 的网站旁的“在此网站上设置 RMS”。
        或-
    -   要恢复群集的数据库，请单击要设置 RMS 的网站旁的“将此服务器添加到群集”选项。

7.  指定以前设置服务器时使用的 RMS 服务帐户。

8.  指定要使用的备份配置数据库（包括数据库名以及该数据库所在的计算机的名称）。

9.  指定以前设置该服务器时使用的同一密码。

10. 单击“**提交**”。

设置过程将启动，并将在服务器上重新设置 RMS。

有关详细信息，请参阅本文档集的“规划 RMS 部署”部分中的“系统恢复计划”以及“备份和恢复 RMS 系统”。

RMS 服务帐户密码已过期
----------------------

如果 RMS 停止运行，可能是因为 RMS 服务帐户密码已过期。查看 IIS 管理器。如果 RMS 应用程序池已停止且无法重新启动它们，则 RMS 服务帐户密码可能已过期。

如果 RMS 服务帐户密码过期，则必须更改每个使用密码已过期帐户的 RMS 服务器上的密码，然后重新启动 IIS。有关详细信息，请参阅本文档集中的“运行 RMS 服务器”中的“更改 RMS 服务帐户密码”。

恢复以前的 RMS 系统
-------------------

如果 RMS 服务器硬件或软件出现故障，可以通过使用以前安装的配置数据库设置新的服务器实例来恢复 RMS 服务器。

> [!NOTE]  
> 只有运行 RMS 的服务器出现故障时，此过程才适用。如果运行配置数据库的服务器出现故障，请参阅本主题中前面的“恢复配置数据库”。如果 RMS 服务器同时也是您的数据库服务器，则必须使用备份副本恢复整个服务器。 

请按照下列过程指向最初安装时所使用的配置数据库：

**恢复以前的 RMS 系统**
1.  使用具有管理权限的帐户登录到要配置为 RMS 服务器的计算机。确保该计算机满足 RMS 的最低系统要求。有关详细信息，请参阅本文档集中的“规划 RMS 部署”中的“RMS 的硬件要求”。

2.  如果使用硬件安全模块来保护 RMS 私钥，请通过使用以前的 RMS 系统所用的相同设置和安全配置来确保该硬件安全模块的配置正确无误。

3.  在该计算机上安装 RMS。

4.  安装完 RMS 之后，单击“**开始**”，依次指向“**所有程序**”和“**Windows RMS**”，然后单击“**Windows RMS 管理**”以打开“**全局管理**”页。

5.  在要设置 RMS 的网站旁边，单击“**将此服务器添加到群集**”。

6.  在“**RMS 服务帐户**”区域中，以 domain\_name\\user\_name 格式键入 RMS 服务帐户的名称并输入相应密码，RMS 将在该帐户下运行以处理大多数例行操作。该帐户必须为域帐户。

7.  在“**配置数据库**”区域中，为要恢复的最初 RMS 系统指定数据库服务器的名称和配置数据库的名称。

8.  在“**私钥保护**”区域中，选择该群集所用的私钥保护机制。如果使用基于软件的私钥保护法，则必须提供以前设置该群集时用于加密私钥的密码。

9.  单击“**提交**”。

客户端由于权限过期无法打开受 RMS 保护的内容
-------------------------------------------

如果用户的权限已过期，则用户无法使用受 RMS 保护的内容。如果 RMS 服务器上的系统时钟比 RMS 客户端上的系统时钟早，则即使用户的权限尚未过期，也可能无法使用受 RMS 保护的内容。因为两台计算机上的系统时钟不同步，所以当客户端计算机尝试打开内容时可能出现以下错误：

**因为您的权限已过期，所以无权打开此消息。想要使用另一套凭据打开它吗？**

客户端许可证和内容许可证都有效，但时间差异导致客户端将内容许可证解释为无效并返回此错误给用户。这可能导致用户认为他们的 RMS 帐户证书有问题或被授予的对该文档的权限有问题。一旦客户端上的时钟到达内容发布许可证的有效时间范围，用户就能够打开该内容。

最佳做法是使 RMS 系统上的客户端和服务器对同一时间服务同步。

当 RMS 尝试将事件记录到应用程序事件日志中时出现“拒绝访问”错误。
---------------------------------------------------------------

默认情况下，从 ASP 页运行的 RMS 之类的组件是在 IUSR\_COMPUTERNAME 帐户下创建的。此帐户是来宾组的成员，而写入应用程序事件日志所需的安全特权会阻止来宾帐户将数据写入事件日志。

要解决此问题，可以使用注册表编辑器来修改控制此行为的注册表项。

> [!CAUTION]   
> 错误编辑注册表可能会严重损坏系统。更改注册表之前，应备份计算机中的所有重要数据。 

将以下注册表项设置为 0 而不是 1，然后重新启动计算机以使更改生效。

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\EventLog\Application`

名称：`RestrictGuestAccess`

类型：`REG_DWORD`

> [!NOTE]  
> 这将使所有来宾帐户都能够对应用程序事件日志执行写入操作。              

有关此错误的原因的详细信息，请参阅 [Microsoft 知识库](https://go.microsoft.com/fwlink/?linkid=44167)中有关从 ASP 页启用日志记录的文章。
